CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/dotfiles"
HASH_FILE="$CACHE_DIR/hm-hash"
CURRENT_HASH=$(nix hash path --type sha256 . 2>/dev/null)
CACHED_HASH=$(cat "$HASH_FILE" 2>/dev/null || echo "")

if [ "$CURRENT_HASH" != "$CACHED_HASH" ]; then
  echo "Dotfiles changed, running home-manager switch..."
  if home-manager switch --impure --flake .; then
    mkdir -p "$CACHE_DIR"
    echo "$CURRENT_HASH" > "$HASH_FILE"
  fi
else 
  echo "Dotfiles unchanged, skipping home-manager switch."
fi
