# dotfiles

Personal dotfiles managed with Nix Home Manager.

## Setup on a new machine

### 1. Install Nix

```bash
# Multi-user installation (recommended)
sh <(curl -L https://nixos.org/nix/install) --daemon

# Or single-user installation
sh <(curl -L https://nixos.org/nix/install) --no-daemon
```

Restart your shell or run:
```bash
. /etc/profile.d/nix.sh
```

### 2. Enable flakes

```bash
mkdir -p ~/.config/nix
echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf
```

### 3. Add yourself to trusted users

Edit `/etc/nix/nix.conf` and add:

```
trusted-users = root <your-username>
```

Then restart the nix daemon:

```bash
sudo systemctl restart nix-daemon
```

### 4. Clone this repository

```bash
git clone https://github.com/vjrasane/dotfiles.git ~/dotfiles
```

### 5. Create local configuration

```bash
cp ~/dotfiles/local.nix.example ~/dotfiles/local.nix
```

Edit `local.nix` with your machine-specific settings:
- `gitUser`, `gitEmail`, `gitSigningKey` - git configuration
- `isWsl` - set to `true` if running in WSL

Note: username, home directory, and system architecture are auto-detected.

### 6. Set up age key for secrets decryption

Create the age key directory and add your private key:

```bash
mkdir -p ~/.config/sops/age
```

Add your age private key to `~/.config/sops/age/keys.txt`. The file should contain:

```
# created: <date>
# public key: age1...
AGE-SECRET-KEY-...
```

This key is used to decrypt secrets (SSH keys, etc.) stored in `secrets.yaml`.

### 7. Apply Home Manager configuration

```bash
nix run home-manager/master -- switch --impure --flake ~/dotfiles
```

This installs all packages and creates symlinks from your home directory to the dotfiles repo.

### 8. Set zsh as default shell

```bash
echo "$(which zsh)" | sudo tee -a /etc/shells
chsh -s $(which zsh)
```

### 9. Install additional tools

```bash
# Tmux Plugin Manager (then press prefix + I in tmux)
git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm

# Rust toolchain
rustup default stable
```

Antidote (zsh plugin manager) auto-installs on first shell start.

## Updating

```bash
# After editing home.nix
home-manager switch --impure --flake ~/dotfiles

# Update flake inputs
nix flake update ~/dotfiles
home-manager switch --impure --flake ~/dotfiles
```

## Directory structure

```
~/dotfiles/
├── flake.nix             # Nix flake entry point
├── home.nix              # Home Manager configuration
├── local.nix             # Machine-specific config (git-ignored)
├── local.nix.example     # Template for local.nix
├── secrets.yaml          # Encrypted secrets (sops)
├── .sops.yaml            # Sops configuration
├── gitconfig             # Shared git settings (aliases, etc.)
├── gitignore             # Global git ignores
├── jj.toml               # Jujutsu config (merged with local settings)
├── .config/
│   ├── nvim/             # Neovim config (symlinked)
│   └── tmux/             # Tmux themes (symlinked)
├── zshrc/                # Modular zsh config
├── .zsh_plugins.txt
├── .p10k.zsh
└── .tmux.conf
```

## What gets symlinked

Home Manager creates these symlinks automatically:

```
~/.tmux.conf   -> ~/dotfiles/.tmux.conf
~/.config/nvim -> ~/dotfiles/.config/nvim
~/.config/tmux -> ~/dotfiles/.config/tmux
```

Note: `~/.gitconfig`, `~/.zshrc`, and `~/.config/jj/config.toml` are generated by Home Manager. Shared git settings are included from `~/dotfiles/gitconfig`. Jujutsu config is merged from `~/dotfiles/jj.toml` with user settings from `local.nix`.
